input {
	tcp {
		port => 4560
		codec => json_lines
	}
}

filter {
	if [level] == "INFO" {
		if "RChain Node" in [message] {
			mutate {
				add_field => { "status" => 0 }
			}
		} else {
			drop {}
		}
	} else if [level] == "WARN" {
		if "did not contain a valid CRC value" in [message] {
			drop {}
		} else if "casper instance was not available yet" in [message] {
			drop {}
		} else if "sender is empty" in [message] {
			drop {}
		} else if "has a lower sequence number than" in [message] {
			drop {}
		} else if "Ignoring block" in [message] {
			drop {}
		} else if "Failed to resolve name" in [message] {
			drop {}
		} else if "peer request timeout" in [message] {
			drop {}
		} else {
			mutate {
				add_field => { "status" => 2 }
			}
		}
	} else if [level] == "ERROR" {
		if "Got response: message dropped" in [message] {
			drop {}
		} else if "Error while handling message. Error: Timeout" in [message] {
			drop {}
		} else if "Peer is currently unavailable" in [message] {
			drop {}
		} else if "peer request timeout" in [message] {
			drop {}
		} else if "Error while streaming packet" in [message] {
			drop {}
		} else if "Computation ran out of phlogistons" in [message] {
			drop {}
		} else {
			mutate {
				add_field => { "status" => 2 }
			}
		}
	} else {
		drop {}
	}

	mutate {
		gsub => [
			"host", "^[^\.]*-(node\d+).*$", "\1.testnet.rchain-dev.tk"
		]
	}

	mutate {
		add_field => { "nagios_output" => "%{level} %{logger_name}: %{message}" }
	}

	if [stack_trace] {
		mutate {
			add_field => { "exception_line" => "%{stack_trace}" }
		}
		mutate {
			gsub => [ "exception_line", "\n.*", "" ]
		}
		mutate {
			replace => {
				"nagios_output" => "%{nagios_output}\nException: %{exception_line}"
			}
		}
	}
}

output {
	http {
		url => "http://nagios.c.developer-222401.internal:6315/submit_result"
		http_method => "post"
		format => "json"
		mapping => {
			"host" => "%{host}"
			"service" => "errors-in-log"
			"status" => "%{status}"
			"output" => "%{nagios_output}"
		}
	}
}
